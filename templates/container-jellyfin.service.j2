[Unit]
Description=Podman container-{{ jellyfin_hostname }}.service
Documentation=man:podman-generate-systemd(1)
Wants=network-online.target
After=network-online.target
RequiresMountsFor=%t/containers

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart={{ jellyfin_systemd_restart_policy }}
TimeoutStopSec={{ jellyfin_systemd_timeout }}
ExecStartPre=/bin/rm -f %t/%n.ctr-id
ExecStartPre=if ! mount | grep '/dev/sdb1 on /media' 1>/dev/null; then mount /media; fi
ExecStart=/usr/bin/podman run \
        --cidfile=%t/%n.ctr-id \
        --cgroups=no-conmon \
        --rm \
        --sdnotify=conmon \
        --replace \
        --detach \
        --label io.containers.autoupdate=registry \
        --name {{ jellyfin_hostname }} \
        --net prod \
        --ip 172.16.20.68 \
        --user {{ jellyfin_uid }}:{{ jellyfin_gid }} \
        --group-add "105" \
        --group-add "39" \
        --volume jellyfin-cache:/cache:Z \
        --volume jellyfin-config:/config:Z \
        --device /dev/dri/renderD128:/dev/dri/renderD128 \
        --device /dev/dri/card0:/dev/dri/card0 \
        --mount type=bind,source={{ jellyfin_media_directory }},destination={{ jellyfin_media_directory }},ro=true \
        docker.io/jellyfin/jellyfin:{{ jellyfin_version }}
ExecStop=/usr/bin/podman stop --ignore --cidfile=%t/%n.ctr-id
ExecStopPost=/usr/bin/podman rm -f --ignore --cidfile=%t/%n.ctr-id
Type=notify
NotifyAccess=all

[Install]
WantedBy=default.target